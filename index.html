<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <title>Dmitri's Vega-Lite Dashboard with KPIs & Filters</title>

  <!-- CDNs -->
  <script src="https://cdn.jsdelivr.net/npm/vega@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-lite@5"></script>
  <script src="https://cdn.jsdelivr.net/npm/vega-embed@6"></script>

  <style>
    :root {
      color-scheme: light dark;
      --bg: #ffffff;
      --text: #111111;
      --border: rgba(0,0,0,.12);
      --card: #ffffff;
      --shadow: 0 1px 2px rgba(0,0,0,.05);
      --accent: #ff7f0e; /* orange bars + primary buttons */
      --muted: rgba(0,0,0,.55);
    }
    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #0c0f12;
        --text: #e6eaef;
        --border: rgba(255,255,255,.16);
        --card: #141a20;
        --shadow: 0 1px 2px rgba(0,0,0,.6);
        --muted: #aab4c1;
      }
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
    }
    header {
      padding: 1rem 1.25rem;
      border-bottom: 1px solid var(--border);
    }
    .wrap { max-width: 1280px; margin: 0 auto; padding: 1.25rem; }

    /* KPI cards */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 1rem;
      margin-bottom: 1.25rem;
    }
    @media (max-width: 1000px) { .kpi-grid { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 560px)  { .kpi-grid { grid-template-columns: 1fr; } }

    .kpi {
      border: 1px solid var(--border);
      border-radius: 16px;
      background: var(--card);
      box-shadow: var(--shadow);
      padding: 1rem 1.25rem;
      display: grid;
      gap: .35rem;
    }
    .kpi .label { font-size: .9rem; color: var(--muted); }
    .kpi .value { font-size: 1.75rem; font-weight: 700; line-height: 1.2; }
    .kpi .delta { font-size: .9rem; }
    .up   { color: #0a7a28; }
    .down { color: #b23a2b; }
    .flat { opacity: .7; }

    /* Filters */
    .filters {
      border: 1px solid var(--border);
      border-radius: 16px;
      background: var(--card);
      box-shadow: var(--shadow);
      padding: 1rem 1.25rem;
      margin-bottom: 1.25rem;
    }
    .filters h3 { margin: 0 0 .75rem; font-size: 1rem; }
    .filters-grid {
      display: grid;
      gap: 1rem;
      grid-template-columns: 1.2fr 1fr 1fr;
    }
    @media (max-width: 900px) { .filters-grid { grid-template-columns: 1fr; } }
    fieldset { margin: 0; border: 0; padding: 0; }
    .pillbox { display: flex; flex-wrap: wrap; gap: .5rem; }
    .pillbox label {
      display: inline-flex; align-items: center; gap: .35rem;
      padding: .35rem .6rem; border: 1px solid var(--border);
      border-radius: 999px; cursor: pointer; font-size: .9rem;
      background: var(--card);
    }
    .pillbox input { accent-color: var(--accent); }

    .range { display: grid; gap: .5rem; }
    .range-row { display: flex; gap: .5rem; align-items: center; }
    .range-row input[type="number"], .range-row input[type="date"] {
      padding: .4rem .5rem; border: 1px solid var(--border); border-radius: 8px;
      background: var(--bg); color: var(--text);
    }

    .filters .actions { margin-top: .5rem; display: flex; gap: .5rem; }
    button {
      padding: .5rem .75rem; border-radius: 10px; border: 1px solid var(--border);
      background: var(--card); color: var(--text); cursor: pointer;
    }
    button.primary { background: var(--accent); border-color: var(--accent); color: #fff; }

    /* Charts grid */
    .charts {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 1.25rem;
    }
    @media (max-width: 900px) { .charts { grid-template-columns: 1fr; } }

    .card {
      border: 1px solid var(--border);
      border-radius: 16px;
      background: var(--card);
      box-shadow: var(--shadow);
      overflow: hidden;
    }
    .card header {
      padding: .9rem 1rem;
      font-weight: 600;
      border-bottom: 1px solid var(--border);
    }
    .card .chart { width: 100%; min-height: 420px; padding: .5rem 1rem 1rem; }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1 style="margin:0;font-size:1.4rem;">Vega-Lite Dashboard (WIP)</h1>
    </div>
  </header>

  <main class="wrap">
    <!-- KPI boxes -->
<section class="kpi-grid">
  <div class="kpi">
    <div class="label">Total Points</div>
    <div class="value" id="kpi-total">—</div>
    <div class="delta flat" id="kpi-total-delta">■ 0.0%</div>
  </div>

  <div class="kpi">
    <div class="label">Average Value</div>
    <div class="value" id="kpi-avg">—</div>
    <div class="delta flat" id="kpi-avg-delta">■ 0.0%</div>
  </div>

  <div class="kpi">
    <div class="label">Max Value</div>
    <div class="value" id="kpi-max">—</div>
    <div class="delta flat" id="kpi-max-delta">■ 0.0%</div>
  </div>

  <div class="kpi">
    <div class="label">Min Value</div>
    <div class="value" id="kpi-min">—</div>
    <div class="delta flat" id="kpi-min-delta">■ 0.0%</div>
  </div>
</section>


    <!-- Filters -->
    <section class="filters" id="filters">
      <h3>Filters</h3>
      <div class="filters-grid">
        <fieldset>
          <legend style="margin-bottom:.5rem;opacity:.8;">Categories</legend>
          <div class="pillbox" id="cat-box"><!-- checkboxes injected by JS --></div>
        </fieldset>

        <fieldset class="range">
          <legend style="margin-bottom:.25rem;opacity:.8;">Value Range</legend>
          <div class="range-row">
            <label for="valMin">Min</label>
            <input id="valMin" type="number" step="1" />
            <label for="valMax">Max</label>
            <input id="valMax" type="number" step="1" />
          </div>
        </fieldset>

        <fieldset class="range">
          <legend style="margin-bottom:.25rem;opacity:.8;">Date Range (Time Series)</legend>
          <div class="range-row">
            <label for="dateStart">Start</label>
            <input id="dateStart" type="date" />
            <label for="dateEnd">End</label>
            <input id="dateEnd" type="date" />
          </div>
        </fieldset>
      </div>
      <div class="actions">
        <button class="primary" id="applyBtn">Apply</button>
        <button id="resetBtn">Reset</button>
      </div>
    </section>

    <!-- Charts -->
    <section class="charts">
      <div class="card">
        <header>Bar Chart (Orange)</header>
        <div id="barChart" class="chart"></div>
      </div>
      <div class="card">
        <header>Line Chart</header>
        <div id="lineChart" class="chart"></div>
      </div>
      <div class="card">
        <header>Scatter Plot</header>
        <div id="scatterChart" class="chart"></div>
      </div>
      <div class="card">
        <header>Rolling Average over Raw Values</header>
        <div id="rollingChart" class="chart"></div>
      </div>
    </section>
  </main>

  <script>
    // ===== Dark-mode aware Vega-Lite config =====
    const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    const vlConfig = prefersDark
      ? {
          background: null,
          axis:   { labelColor: '#e6eaef', titleColor: '#e6eaef', domainColor: '#5b6775', tickColor: '#5b6775' },
          legend: { labelColor: '#e6eaef', titleColor: '#e6eaef' }
        }
      : { background: null };

    // ===== Data (master) =====
    const ALL_CATS = ["A","B","C","D","E","F","G","H"];

    const dataBar = [
      {category:"A", value:30}, {category:"B", value:55},
      {category:"C", value:43}, {category:"D", value:91},
      {category:"E", value:70}, {category:"F", value:38}
    ];

    // Use consistent `value` across charts to reuse filters
    const dataLine = [
      {x:0, value:2, category:"A"}, {x:1, value:6, category:"B"},
      {x:2, value:3, category:"C"}, {x:3, value:10, category:"D"},
      {x:4, value:7, category:"E"}, {x:5, value:12, category:"F"},
      {x:6, value:9, category:"G"}
    ];

    const dataScatter = [
      {x:1, value:2, category:"A"}, {x:2, value:3, category:"B"},
      {x:3, value:5, category:"C"}, {x:4, value:4, category:"D"},
      {x:5, value:7, category:"E"}, {x:6, value:6, category:"F"},
      {x:7, value:4, category:"G"}, {x:7, value:7, category:"H"}
    ];

    const dataTime = [
      {date:"2025-09-01", value:12, category:"A"},{date:"2025-09-02", value:18, category:"B"},
      {date:"2025-09-03", value:10, category:"C"},{date:"2025-09-04", value:22, category:"D"},
      {date:"2025-09-05", value:16, category:"E"},{date:"2025-09-06", value:24, category:"F"},
      {date:"2025-09-07", value:20, category:"G"},{date:"2025-09-08", value:26, category:"H"},
      {date:"2025-09-09", value:19, category:"A"},{date:"2025-09-10", value:28, category:"B"},
      {date:"2025-09-11", value:25, category:"C"},{date:"2025-09-12", value:29, category:"D"},
      {date:"2025-09-13", value:21, category:"E"},{date:"2025-09-14", value:30, category:"F"},
      {date:"2025-09-15", value:27, category:"G"},{date:"2025-09-16", value:33, category:"H"},
      {date:"2025-09-17", value:26, category:"A"},{date:"2025-09-18", value:35, category:"B"},
      {date:"2025-09-19", value:31, category:"C"},{date:"2025-09-20", value:34, category:"D"}
    ];

    // Defaults
    const VALUE_MIN = 0, VALUE_MAX = 100;
    const DATE_MIN = "2025-09-01", DATE_MAX = "2025-09-30";

    // ===== Build category checkboxes =====
    const catBox = document.getElementById("cat-box");
    ALL_CATS.forEach(c => {
      const id = `cat_${c}`;
      const label = document.createElement("label");
      label.innerHTML = `<input type="checkbox" id="${id}" value="${c}" checked /> ${c}`;
      catBox.appendChild(label);
    });

    // Range defaults
    const valMinEl = document.getElementById("valMin");
    const valMaxEl = document.getElementById("valMax");
    valMinEl.value = VALUE_MIN; valMaxEl.value = 100;

    const dateStartEl = document.getElementById("dateStart");
    const dateEndEl = document.getElementById("dateEnd");
    dateStartEl.value = DATE_MIN; dateEndEl.value = DATE_MAX;

    // ===== Helpers =====
    function getFilters() {
      const selectedCats = Array.from(catBox.querySelectorAll('input[type=checkbox]:checked')).map(i => i.value);
      const vmin = Number(valMinEl.value || VALUE_MIN);
      const vmax = Number(valMaxEl.value || VALUE_MAX);
      const dmin = dateStartEl.value || DATE_MIN;
      const dmax = dateEndEl.value || DATE_MAX;
      return { selectedCats, vmin, vmax, dmin, dmax };
    }
    const inValueRange = (v, vmin, vmax) => v >= vmin && v <= vmax;
    const inCat = (cat, cats) => cats.includes(cat);
    const inDate = (d, dmin, dmax) => !d || (d >= dmin && d <= dmax);

    function applyFilters(filters) {
      const { selectedCats, vmin, vmax, dmin, dmax } = filters;
      const bar = dataBar.filter(r => inCat(r.category, selectedCats) && inValueRange(r.value, vmin, vmax));
      const line = dataLine.filter(r => inCat(r.category, selectedCats) && inValueRange(r.value, vmin, vmax));
      const scat = dataScatter.filter(r => inCat(r.category, selectedCats) && inValueRange(r.value, vmin, vmax));
      const time = dataTime.filter(r =>
        inCat(r.category, selectedCats) && inValueRange(r.value, vmin, vmax) && inDate(r.date, dmin, dmax)
      );
      return { bar, line, scat, time };
    }

    function updateKPIs(filtered) {
      const all = [...filtered.bar, ...filtered.line, ...filtered.scat, ...filtered.time];
      const total = all.length;
      const values = all.map(d => d.value);
      const avg = values.length ? values.reduce((a,b)=>a+b,0)/values.length : 0;
      const max = values.length ? Math.max(...values) : 0;
      const min = values.length ? Math.min(...values) : 0;

      document.getElementById('kpi-total').textContent = total.toLocaleString();
      document.getElementById('kpi-avg').textContent = avg.toFixed(2);
      document.getElementById('kpi-max').textContent = max.toFixed(0);
      document.getElementById('kpi-min').textContent = min.toFixed(0);

      // Placeholder deltas
      ["total","avg","max","min"].forEach(k => {
        const el = document.getElementById(`kpi-${k}-delta`);
        if (el) { el.className = "delta flat"; el.textContent = "■ 0.0%"; }
      });
    }

    // ===== Base spec + embed opts (include dark-mode config) =====
    const base = {
      $schema: "https://vega.github.io/schema/vega-lite/v5.json",
      autosize: { type: "fit", contains: "padding" },
      width: "container",
      height: 400,
      config: vlConfig
    };
    const embedOpts = { actions: { export: true, source: true, editor: true } };

    function renderCharts(filtered) {
      const barSpec = {
        ...base,
        data: { values: filtered.bar },
        mark: { type: "bar", color: getComputedStyle(document.documentElement).getPropertyValue('--accent').trim() || '#ff7f0e', cornerRadiusTopLeft: 6, cornerRadiusTopRight: 6 },
        encoding: {
          x: { field: "category", type: "nominal", axis: { labelAngle: 0, title: "Category" }},
          y: { field: "value", type: "quantitative", axis: { title: "Value" }},
          tooltip: [{field:"category"}, {field:"value"}]
        }
      };

      const lineSpec = {
  ...base,
  data: { values: filtered.line },
  mark: {
    type: "line",
    point: {
      filled: true,
      size: 120,
      shape: "diamond"
    }
  },
  encoding: {
    x: { field: "x", type: "quantitative", title: "X" },
    y: { field: "value", type: "quantitative", title: "Value" },
    color: { field: "category", type: "nominal", legend: { title: "Category" } },
    tooltip: [{ field: "x" }, { field: "value" }, { field: "category" }]
  }
};

      const scatterSpec = {
        ...base,
        data: { values: filtered.scat },
        mark: "point",
        encoding: {
          x: { field: "x", type: "quantitative" },
          y: { field: "value", type: "quantitative" },
          color: { field: "category", type: "nominal", legend: { title: "Category" } },
          tooltip: [{field:"x"}, {field:"value"}, {field:"category"}]
        }
      };

      const rollingSpec = {
        ...base,
        data: { values: filtered.time },
        transform: [
          { window: [{ op: "mean", field: "value", as: "rolling_7d" }], frame: [-6, 0], sort: [{ field: "date", order: "ascending" }] }
        ],
        layer: [
          { mark: { type: "line", interpolate: "monotone", opacity: 0.45 },
            encoding: {
              x: { field: "date", type: "temporal", title: "Date" },
              y: { field: "value", type: "quantitative", title: "Value" },
              color: { field: "category", type: "nominal", legend: { title: "Category" } },
              tooltip: [{ field: "date", type: "temporal" }, { field: "value", type: "quantitative" }, { field: "category", type: "nominal"}]
            }
          },
          { mark: { type: "point", filled: true, opacity: 0.35, size: 40 },
            encoding: { x: { field: "date", type: "temporal" }, y: { field: "value", type: "quantitative" }, color: { field: "category", type: "nominal" } }
          },
          { mark: { type: "line", strokeWidth: 3 },
            encoding: {
              x: { field: "date", type: "temporal" },
              y: { field: "rolling_7d", type: "quantitative", title: "Value (7-day avg)" },
              color: { value: prefersDark ? '#e6eaef' : '#333' },
              tooltip: [{ field: "date", type: "temporal" }, { field: "rolling_7d", type: "quantitative", title: "7-day Avg", format: ".2f" }]
            }
          }
        ]
      };

      vegaEmbed("#barChart", barSpec, embedOpts);
      vegaEmbed("#lineChart", lineSpec, embedOpts);
      vegaEmbed("#scatterChart", scatterSpec, embedOpts);
      vegaEmbed("#rollingChart", rollingSpec, embedOpts);
    }

    function applyAndRender() {
      const filters = getFilters();
      const filtered = applyFilters(filters);
      updateKPIs(filtered);
      renderCharts(filtered);
    }

    // Buttons
    document.getElementById("applyBtn").addEventListener("click", applyAndRender);
    document.getElementById("resetBtn").addEventListener("click", () => {
      catBox.querySelectorAll('input[type=checkbox]').forEach(cb => cb.checked = true);
      valMinEl.value = VALUE_MIN;
      valMaxEl.value = 100;
      dateStartEl.value = DATE_MIN;
      dateEndEl.value = DATE_MAX;
      applyAndRender();
    });

    // Initial render
    applyAndRender();

    // Optional: live-respond to OS theme changes without reload
    if (window.matchMedia) {
      window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => location.reload());
    }
  </script>
</body>
</html>
